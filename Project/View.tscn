[gd_scene load_steps=6 format=2]

[ext_resource path="res://Level.tscn" type="PackedScene" id=1]
[ext_resource path="res://assets/palette.png" type="Texture" id=2]

[sub_resource type="Shader" id=1]
code = "shader_type canvas_item;

uniform vec4 tint : hint_color;
uniform int pixel_size = 3;
uniform float tint_mix = 0;
uniform float tint_contrast = 1.0;
uniform sampler2D palette;

void fragment(){
    vec2 psize = (1.0/float(pixel_size))/TEXTURE_PIXEL_SIZE;
    vec2 grid = vec2((0.5+floor(UV.x * psize.x)) /psize.x, (0.5+floor(UV.y * psize.y)) /psize.y);
    
    vec3 color = texture(TEXTURE, grid).rgb;
    ivec2 size = textureSize(palette, 0);
    color = mix(color, tint.rgb, tint_mix);
    color = mix(vec3(0.5), color.rgb, tint_contrast);
    vec4 closest_color = vec4(1.0,0.0,0.0,1.0);
    float distance_to_color = 500.0;
    for (float x = 0.5; x < float(size.x); x += 1.0) {
        for (float y = 0.5; y < float(size.y); y += 1.0) {
            vec4 pal_col = texture(palette, vec2(x/float(size.x),y/float(size.y)));
            if (distance(color.rgb, pal_col.rgb) < distance_to_color){
                distance_to_color = distance(color.rgb, pal_col.rgb);
                closest_color = pal_col;//vec4(1.0,0.0,0.0,1.0);
            }
        }
    }
    COLOR = closest_color;
}"

[sub_resource type="ShaderMaterial" id=2]
shader = SubResource( 1 )
shader_param/tint = Color( 1, 0.811765, 0.811765, 1 )
shader_param/pixel_size = 3
shader_param/tint_mix = 0.0
shader_param/tint_contrast = 1.0
shader_param/palette = ExtResource( 2 )

[sub_resource type="Environment" id=3]
ambient_light_color = Color( 1, 1, 1, 1 )
fog_enabled = true
fog_color = Color( 0, 0, 0, 1 )

[node name="View" type="CanvasLayer"]

[node name="ViewportContainer" type="ViewportContainer" parent="."]
material = SubResource( 2 )
anchor_right = 1.0
anchor_bottom = 1.0
stretch = true

[node name="Viewport" type="Viewport" parent="ViewportContainer"]
size = Vector2( 1024, 600 )
handle_input_locally = false
render_target_update_mode = 3

[node name="WorldEnvironment" type="WorldEnvironment" parent="ViewportContainer/Viewport"]
environment = SubResource( 3 )

[node name="Level" parent="ViewportContainer/Viewport" instance=ExtResource( 1 )]
